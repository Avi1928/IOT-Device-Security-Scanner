{% extends "base.html" %}

{% block title %}IoT Security Dashboard{% endblock %}
{% block nav_home %}active{% endblock %}
{% block header_title %}IOT Device Security Scanner{% endblock %}

{% block content %}
<div class="row">
    <!-- Scan Control Card -->
    <div class="col-xl-4 col-lg-5">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-search text-primary"></i> Scan Controls
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <label for="ip_range" class="form-label fw-bold text-secondary small text-uppercase">Target Network</label>
                    <div class="input-group mb-3">
                        <span class="input-group-text bg-light"><i class="bi bi-globe"></i></span>
                        <input type="text" id="ip_range" class="form-control" placeholder="e.g., 192.168.1.0/24" value="192.168.1.0/24">
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-modern" onclick="startScan()" id="start-btn">
                            <i class="bi bi-radar"></i> Start Discovery
                        </button>
                        <button class="btn btn-light btn-modern text-secondary" onclick="getLocalRange()">
                            <i class="bi bi-magic"></i> Auto-Detect Range
                        </button>
                    </div>
                </div>

                <hr class="my-4">

                <div class="text-center">
                    <label class="form-label fw-bold text-secondary small text-uppercase mb-3">Scan Progress</label>
                    
                    <div class="circular-progress-container">
                        <div class="circular-progress">
                            <svg viewBox="0 0 160 160">
                                <circle class="bg" cx="80" cy="80" r="70"></circle>
                                <circle class="fg" id="progress-circle" cx="80" cy="80" r="70"></circle>
                            </svg>
                            <div class="percentage" id="progress-text">0%</div>
                        </div>
                    </div>
                    
                    <div id="status-container">
                        <h5 id="status-text" class="fw-bold text-dark mb-1">Ready</h5>
                        <p id="current-target" class="text-muted small mb-2 text-truncate" style="min-height: 20px;"></p>
                        <div id="scan-controls" style="display: none;">
                            <button class="btn btn-danger btn-sm rounded-pill px-3" onclick="stopScan()">
                                <i class="bi bi-stop-circle"></i> Stop
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 pt-3 border-top">
                     <button class="btn btn-success w-100 btn-modern" onclick="saveCurrentScan()" id="save-btn" disabled>
                        <i class="bi bi-save"></i> Save Results
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Grid -->
    <div class="col-xl-8 col-lg-7">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-hdd-network text-primary"></i> Discovered Devices</span>
                <span class="badge bg-primary rounded-pill" id="device-count">0 Found</span>
            </div>
            <div class="card-body bg-light p-3">
                <div id="results-area" class="row g-3">
                    <!-- Empty State -->
                    <div class="col-12 text-center py-5 text-muted" id="empty-state">
                        <i class="bi bi-router display-1 opacity-25"></i>
                        <p class="mt-3">Start a scan to discover IoT devices on your network.</p>
                    </div>
                    <!-- Devices will be injected here as cards -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let isScanning = false;
let currentScanId = null;
let pollInterval = null;
const CIRCUMFERENCE = 2 * Math.PI * 70; // r=70

function getLocalRange() {
    fetch("/api/localrange")
        .then(res => res.json())
        .then(data => {
            document.getElementById("ip_range").value = data.range;
        });
}

function startScan() {
    if (isScanning) return;
    
    const target = document.getElementById("ip_range").value;
    if (!target) { alert("Please enter a target."); return; }
    
    // UI Reset
    const progressCircle = document.getElementById("progress-circle");
    progressCircle.style.strokeDashoffset = CIRCUMFERENCE;
    document.getElementById("progress-text").innerText = "0%";
    document.getElementById("status-text").innerText = "Starting...";
    document.getElementById("save-btn").disabled = true;
    document.getElementById("start-btn").disabled = true;
    document.getElementById("scan-controls").style.display = "block";
    document.getElementById("results-area").innerHTML = '';
    document.getElementById("device-count").innerText = "0 Found";
    
    isScanning = true;
    
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(pollStatus, 1000);
    
    fetch("/api/scan", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({target: target})
    }).then(res => res.json()).then(data => {
        if(data.status === "error") {
            alert(data.message);
            stopScanUI();
        }
    });
}

function stopScan() {
    if (!isScanning) return;
    if (confirm('Stop the scan?')) {
        fetch("/api/reset_scan", { method: "POST" });
        stopScanUI();
        document.getElementById("status-text").innerText = "Stopped";
    }
}

function stopScanUI() {
    isScanning = false;
    if (pollInterval) clearInterval(pollInterval);
    document.getElementById("scan-controls").style.display = "none";
    document.getElementById("start-btn").disabled = false;
}

function pollStatus() {
    if (!isScanning) return;
    
    fetch("/api/status?" + Date.now()).then(r => r.json()).then(data => {
        // Update Progress
        const progress = Math.min(100, data.progress || 0);
        const offset = CIRCUMFERENCE - (progress / 100) * CIRCUMFERENCE;
        document.getElementById("progress-circle").style.strokeDashoffset = offset;
        document.getElementById("progress-text").innerText = progress + "%";
        
        // Update Text
        if(data.status === "running") {
            document.getElementById("status-text").innerText = "Scanning...";
            document.getElementById("current-target").innerText = data.current_device || "";
        } else if (data.status === "done") {
            document.getElementById("status-text").innerText = "Complete";
            document.getElementById("current-target").innerText = "";
            stopScanUI();
            if (data.scan_id) {
                currentScanId = data.scan_id;
                document.getElementById("save-btn").disabled = false;
            }
        } else if (data.status && data.status.startsWith("error")) {
            document.getElementById("status-text").innerText = "Error";
            stopScanUI();
        }
        
        // Render Devices
        const resultsArea = document.getElementById("results-area");
        const devices = data.results && data.results.devices ? data.results.devices : [];
        document.getElementById("device-count").innerText = `${devices.length} Found`;
        
        if (devices.length > 0) {
            // Simple optimization: only re-render if count changes to avoid flickering, 
            // but ideally we'd diff. For now, just clear and rebuild is okay for small lists.
            // Or even better, append new ones. But let's stick to rebuild for simplicity.
            resultsArea.innerHTML = "";
            devices.forEach(ip => {
                const cardHtml = `
                    <div class="col-md-6 col-lg-4 fade-in">
                        <div class="card h-100 border-start border-4 border-primary p-3 shadow-sm">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="mb-1 fw-bold text-dark">${ip}</h5>
                                    <span class="badge bg-light text-dark border">IoT Device</span>
                                </div>
                                <i class="bi bi-router-fill text-primary fs-4"></i>
                            </div>
                            <div class="mt-3 pt-2 border-top">
                                <button onclick="window.open('/scan_device/${ip}?autostart=true', '_blank')" class="btn btn-sm btn-outline-primary w-100">
                                    <i class="bi bi-shield-check"></i> Security Scan
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                resultsArea.innerHTML += cardHtml;
            });
        } else if (data.status === "running") {
             resultsArea.innerHTML = `<div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2 text-muted">Searching network...</p></div>`;
        }
    });
}

function saveCurrentScan() {
    const btn = document.getElementById('save-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
    
    fetch("/api/save_current_scan", {method: "POST"})
    .then(r => r.json())
    .then(data => {
        if(data.status === "success") {
            alert("Saved successfully!");
            btn.innerHTML = '<i class="bi bi-check-lg"></i> Saved';
        } else {
            alert("Error: " + data.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-save"></i> Save Results to DB';
        }
    });
}

// Init
getLocalRange();
</script>
<style>
    .fade-in { animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
</style>
{% endblock %}
